### 项目目标

* 利用循环神经网络（LSTM 或 GRU）学习受迫单摆的动力学特性。
* 构建一个能够泛化预测**不同初始条件**和 **不同正弦外力参数** （振幅、频率）下单摆状态（角度、角速度）的模型。
* 开发评估工具和可视化方法来分析模型性能。

### 核心组件 (代码脚本)

我们目前主要形成了以下几个脚本：

1. **`训练脚本 (train.py)`** :

* **核心功能** : 负责整个模型的训练流程。
* **数据生成** : 使用 **RK4** 方法模拟**多个**包含不同初始条件和外力参数的场景，生成包含 `(theta, omega, force)` 三个特征的数据。
* **预处理** : 使用 **StandardScaler** 对聚合后的数据进行标准化；将数据切分为序列（输入 `X` 为 3 特征，目标 `y` 为 2 特征 `theta, omega`）；划分训练、验证、测试集。
* **模型** : 定义了通用的 `PendulumRNN` 类，可通过命令行参数选择 **LSTM** 或  **GRU** ，并指定**隐藏单元数 (H)** 和 **层数 (L)** 、 **序列长度 (Seq)** 。
* **训练** : 使用 Adam 优化器、MSE 损失函数，并集成了 **验证集** 、**早停法 (Early Stopping)** 和 **`学习率调度器 (ReduceLROnPlateau)`** 。
* **保存** : 训练结束后，自动保存验证集上性能最佳的模型 (`.pth`) 和对应的 Scaler (`.joblib`) 到以参数命名的文件夹中。
* **内置评估** : 训练完成后，会对预定义的 5 个测试场景进行 **多步预测 (Multi-step Prediction)** ，并将结果（位置对比、速度对比、位置误差、速度误差）绘制成**静态图**保存。

1. **`模拟器脚本 (多步：play_anim.py 单步：play_anim_one_step.py)`** :

* **核心功能** : 加载一个**已训练好**的模型，并对用户通过**命令行指定**的 **单一场景** （初始条件、外力参数）进行可视化模拟和预测对比。
* **加载** : 根据命令行提供的模型参数（H, L, Seq, Type）找到并加载对应的 `.pth` 模型文件和 `.joblib` Scaler 文件。
* **运行** : 同时运行 RK4 模拟（作为基准）和加载的模型进行 **多步预测** 。
* **可视化** : 生成一个包含 **4 个子图**的 **实时动画** ，展示：叠加的真实与预测单摆、角度误差曲线、角速度误差曲线、角速度对比曲线。

1. **`多模型评估脚本 (多步预测) (evaluate.py)`** :

* **核心功能** : 对**多个**预训练好的模型配置进行 **横向比较** 。
* **评估方法** : 对每个模型，在多个标准测试场景下运行 **多步预测** ，计算预测轨迹与真实轨迹之间的 **平均 RMSE** （区分角度和角速度）。
* **输出** : 打印包含所有模型配置及其平均多步预测 RMSE 的 **性能排行榜** ，并指出最佳模型。

1. **`多模型评估脚本 (单步预测) (evaluate_one_step.py)`** :

* **核心功能** : 同样对多个预训练模型进行横向比较。
* **评估方法** : 评估模型在给定**完美历史**信息的情况下，预测**紧邻下一步**状态的能力。它遍历测试轨迹的每一步，用真实历史做输入进行预测，计算预测值与真实值之间的 **平均单步预测 RMSE** 。
* **输出** : 打印包含所有模型配置及其平均单步预测 RMSE 的性能排行榜，并指出最佳模型。

1. **`多模型评估脚本 (随机外力) (evaluate_with_random_forces.py)`** :

* **核心功能** : 测试预训练模型（在正弦力上训练的）在**未见过的随机外力**下的 **鲁棒性** 。
* **模拟** : 生成带有 **随机外力** （带有时间相关的噪声）的基准轨迹。
* **评估方法** : 使用**单步预测**方法，评估模型在输入包含随机力时的即时响应预测能力，计算平均单步预测 RMSE。
* **输出** : 打印模型在随机外力下的性能排行。

### 当前最佳实践与发现

* **模型选择** : 在我们的测试中，**LSTM** 在 M2 Mac 的 MPS 后端上通常表现出比 GRU 更好的性能（或更快的单轮速度）。
* **模型容量** : 并非越大越好。较大的模型（如 H=256, L=3）容易 **过拟合** ，在验证集和测试集上的表现可能不如更精简的模型（如 H=128/L=2 或 H=32/L=2）。H=32/L=2 已能取得不错效果（最大角度误差~0.05 rad）。
* **数据质量** : 使用 **RK4** 模拟代替欧拉法对提升精度有帮助。
* **数据标准化** : **StandardScaler** 比 MinMaxScaler 在处理这个问题（尤其是对称性）上效果更好。
* **训练策略** :  **验证集** 、**早停法**和**学习率调度器**对于防止过拟合、提高训练效率和寻找更优模型非常重要。训练通常很早就进入平台期。
* **输入特征** :
* 将瞬时外力 `force` 作为输入是必要的。
* 尝试将角加速度 `omega_dot` 作为输入（无论是否作为输出）都导致了训练损失升高，效果不如此前不包含加速度的版本。
* 不直接提供外力参数 `amp`, `freq` 而让模型隐式学习，理论上可行但实践中非常困难。
* **误差模式** : **误差累积**是长期多步预测的主要挑战，表现为相位和幅度的逐渐偏离。模型在转折点（速度接近零）附近的预测误差相对较大。
* **评估方法** : 多步预测评估（误差累积）和单步预测评估（即时响应）提供了模型性能的不同视角。

### 潜在的后续优化方向

* 系统性地调整 **`序列长度 SEQ_LENGTH`** 。
* 进一步 **`增加训练数据量 NUM_SIMULATIONS`** 。
* 在当前最佳模型配置 (如 LSTM H=32 L=2 或 H=128 L=2) 基础上尝试**`增加层数 (NUM_LAYERS = 3)`** 或微调隐藏单元数。
* 尝试**不同的优化器** (如 AdamW) 或更精细地调整 **学习率及调度策略** 。
* 尝试**正则化**技术（如 Weight Decay 或重新小剂量尝试 Dropout）来配合更大容量的模型。
* 探索更复杂的模型架构，如**双向 LSTM/GRU** 或加入  **Attention 机制** 。
